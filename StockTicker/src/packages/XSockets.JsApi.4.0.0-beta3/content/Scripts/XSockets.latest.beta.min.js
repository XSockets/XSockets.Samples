var XSockets={Version:"4.0",Events:{onError:"0x1f4",onOpen:"0xc8",onClose:"0xcb",init:"0xcc",controller:{onError:"0x1f4",onOpen:"0x14",onClose:"0x15"},storage:{set:"0x190",get:"0x191",clear:"0x192",remove:"0x193"},pubSub:{subscribe:"0x12c",unsubscribe:"0x12d"}},Utils:{longToByteArray:function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},stringToBuffer:function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},parseUri:function(n){for(var u,f,r,e,t={},o={port:80,relative:"/"},s=["url","scheme","host","domain","port","fullPath","path","relative","controller","query"],h=n.match(/^(?:([^:\/?#]+):)?(?:\/\/(([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)/),i=0;i<s.length;i++)t[s[i]]=h[i];if(t.rawQuery=t.query||"",t.query){for(u={},f=t.query.split("&"),r=0;r<f.length;r++)e=f[r].split("="),u[e[0]]=e[1];t.query=u}else t.query={};return t=XSockets.Utils.extend(o,t),t.absoluteUrl=t.scheme+"://"+t.domain+":"+t.port+o.relative+t.controller,t},randomString:function(n){for(var t="",i;t.length<n&&n>0;)i=Math.random(),t+=String.fromCharCode(Math.floor(i*26)+(i>.5?97:65));return t},getParameterByName:function(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+n+"=([^&#]*)",r=new RegExp(i),t=r.exec(window.location.search);return t==null?"":decodeURIComponent(t[1].replace(/\+/g," "))},extend:function(n,t){var i,r;if(arguments.length>2)for(i=1;i<arguments.length;i++)this.extend(n,arguments[i]);else for(r in t)n[r]=t[r];return n},guid:function(n,t){for(t=n="";n++<36;t+=n*51&52?(n^15?8^Math.random()*(n^20?16:4):4).toString(16):"-");return t}}};XSockets.ClientInfo=function(){function n(n,t,i){arguments.length===1?this.controller=arguments[0]:(this.persistentId=t,this.connectionId=n,this.controller=i,localStorage.setItem(this.controller,JSON.stringify(this)))}return n.prototype.get=function(){return localStorage.getItem(this.controller)},n}();XSockets.BinaryMessage=function(){function n(n,t,i){var r,u,e;if(!window.Uint8Array)throw"Unable to create a XSockets.BinaryMessage, the browser does not support Uint8Array";if(arguments.length===3)r=n.toString(),this.id=new XSockets.Utils.guid,this.header=new Uint8Array(XSockets.Utils.longToByteArray(r.length)),this.buffer=this.appendBuffer(this.appendBuffer(this.header,this.stringToBuffer(r)),t),i&&i(this);else if(arguments.length===2){u=new Uint8Array(n,0,8);byteArrayToLong=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return t};var o=byteArrayToLong(u),f=8+byteArrayToLong(u),s=new Uint8Array(n,f,n.byteLength-f),h=new Uint8Array(n,8,o);function c(n){return String.fromCharCode.apply(null,new Uint16Array(n))}e=(new XSockets.Message).parse(c(h),s);t(e)}}return n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.getHeader=function(){return this.header},n}();XSockets.Subscriptions=function(){var n=function(){this._subscriptions=[];Object.defineProperty(this._subscriptions,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(n){var t;if(typeof n!="function")throw new TypeError("predicate must be a function");var i=Object(this),u=i.length>>>0,f=arguments[1],r;for(t=0;t<u;t++)if(t in i&&(r=i[t],n.call(f,r,t,i)))return r;return undefined}});Object.defineProperty(this._subscriptions,"findIndex",{enumerable:!1,configurable:!0,writable:!0,value:function(n){var t;if(typeof n!="function")throw new TypeError("predicate must be a function");var i=Object(this),u=i.length>>>0,f=arguments[1],r;for(t=0;t<u;t++)if(t in i&&(r=i[t],n.call(f,r,t,i)))return t;return-1}})};return n.prototype.get=function(n){return this._subscriptions.find(n)},n.prototype.add=function(n){return this._subscriptions.push(n),this},n.prototype.remove=function(n){var t=this._subscriptions.findIndex(function(t){return t.topic===n});return t>=0&&this._subscriptions.splice(t,1),this},n.prototype.getAll=function(){return this._subscriptions},n}();XSockets.Message=function(){function n(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}}return n.prototype.parse=function(n,t){var i=JSON.parse(n);return{topic:i.T,controller:i.C,data:JSON.parse(i.D),binary:t}},n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}();XSockets.Communcation=function(){var n,t=function(n,t,i){var u=[],r=new window.WebSocket(n,i),c=arguments;r.binaryType="arraybuffer";r.onmessage=t.onmessage;r.onclose=t.onclose;r.onopen=function(n){for(var i=0;i<u.length;i++)f(u[i]);u=[];t.onopen(n)};var e=function(){return XSockets.Utils.guid()},f=function(n){r.readyState===0?u.push(n):r.readyState===1&&r.send(n)},o=function(){r.close()},s=function(){return r.readyState},h=function(){return typeof WebSocket=="undefined"?"Fallback":"WebSocket"in window&&window.WebSocket.CLOSED>2?"RFC6455":"Hixie"}();return{send:f,instanceId:e(),clientType:h,readyState:s,close:o,binaryType:function(n){r.binaryType=n},getWebSocket:function(){return r}}};return{getInstance:function(i,r,u,f){return(!n||f)&&(n=t(i.toLowerCase(),r,u)),n}}}();XSockets.Controller=function(){var n=function(n,t){this.promises={};this.webSocket=t;this.instanceId=XSockets.Utils.guid();this.subscriptions=new XSockets.Subscriptions;this.clientInfo=new XSockets.ClientInfo(n);this.name=n.toLowerCase()};return n.prototype.close=function(){return this.webSocket.send(new XSockets.Message(XSockets.Events.controller.onClose,{},this.name)),this},n.prototype.storageGet=function(n,t){var i=XSockets.Events.storage.get+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.get,{K:n},this.name)),t&&this.promises[i].promise.then(t),this.promises[i].promise},n.prototype.storageRemove=function(n,t){var i=XSockets.Events.storage.remove+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.remove,{K:n},this.name)),t&&this.promises[i].promise.then(t),this.promises[i].promise},n.prototype.storageClear=function(n){var t=XSockets.Events.storage.clear+":"+XSockets.Utils.randomString(8),i=new XSockets.Deferred;return this.promises[t]=i,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.clear,{},this.name)),n&&this.promises[t].promise.then(n),this.promises[t].promise},n.prototype.storageSet=function(n,t){var i=XSockets.Events.storage.set+":"+n,r=new XSockets.Deferred;return this.promises[i]=r,this.webSocket.send(new XSockets.Message(XSockets.Events.storage.set,{K:n,V:typeof t=="object"?JSON.stringify(t):t},this.name)),this.promises[i].promise},n.prototype.setProperty=function(n,t){var r="set_"+n.toLowerCase(),i;i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};this.publish(new XSockets.Message(r,i,this.name))},n.prototype.setEnum=function(n,t){var i="set_"+n.toLowerCase();this.publish(new XSockets.Message(i,t,this.name))},n.prototype.addListener=function(n,t){this.subscriptions.add(new XSockets.Subscription(n,t))},n.prototype.onopen=undefined,n.prototype.onclose=undefined,n.prototype.onmessage=undefined,n.prototype.onerror=undefined,n.prototype.invoke=function(n,t,i){n=n.toLowerCase();var r=new XSockets.Deferred;return this.publish(n,t,i),this.promises[n]=r,this.promises[n].promise},n.prototype.publish=function(n,t,i){return n instanceof XSockets.BinaryMessage?(this.webSocket.send(arguments[0].buffer),arguments.length===2&&t()):n instanceof XSockets.Message&&(this.webSocket.send(n.toString()),arguments.length>1&&typeof arguments[1]=="function"&&t()),typeof n=="string"&&(this.webSocket.send(new XSockets.Message(n,t||{},this.name).toString()),arguments.length>2&&typeof i=="function"&&i()),this},n.prototype.subscribe=function(n,t,i){return this.publish(new XSockets.Message(XSockets.Events.pubSub.subscribe,{T:n,A:i?!0:!1},this.name)),i&&this.addListener("__"+n,i),this.subscriptions.add(new XSockets.Subscription(n,t)),this},n.prototype.on=function(n,t){return this.addListener(n,t,this.name),this},n.prototype.disposeListener=function(n,t){return this.subscriptions.remove(n),this.hasOwnProperty(n)&&delete this[n],t&&t(),this},n.prototype.many=function(n,t,i,r){return this.publish(new XSockets.Message(XSockets.Events.pubSub.subscribe,{T:n,A:r?!0:!1},this.name)),r&&this.addListener("__"+n,r),this.subscriptions.add(new XSockets.Subscription(n,i,t)),this},n.prototype.unsubscribe=function(n,t){return this.publish(new XSockets.Message(XSockets.Events.pubSub.unsubscribe,{T:n},t||this.name)),this.subscriptions.remove(n),this},n.prototype.one=function(n,t,i){return this.many(n,1,t,i),this},n.prototype.onopen=undefined,n.prototype.onclose=undefined,n.prototype.onmessage=undefined,n.prototype.onerror=undefined,n}();XSockets.WebSocket=function(){function n(n,t,i){var r=this,f,u;this._args=arguments;this.promises={};this.controllerInstances=[];this.uri=XSockets.Utils.parseUri(n);f=XSockets.Utils.extend(r.uri.query,i?i:{});this.settings=XSockets.Utils.extend({parameters:f,subprotocol:"XSocketsNET",queryString:function(){var n="?";for(var t in this.parameters)n+=t+"="+encodeURIComponent(this.parameters[t])+"&";return n.slice(0,n.length-1)}},{});localStorage.getItem(this.uri.absoluteUrl)&&(this.settings.parameters.persistentId=localStorage.getItem(this.uri.absoluteUrl));this.getInstace=function(n,t,i){return XSockets.Communcation.getInstance(n,{onmessage:function(n){var t,i;typeof n.data=="string"?(t=(new XSockets.Message).parse(n.data),t.topic===XSockets.Events.onError?r.dispatchMessage(XSockets.Events.onError,t,t.controller):r.dispatchMessage(t.topic,t.data,t.controller)):typeof n.data=="object"&&(i=new XSockets.BinaryMessage(n.data,function(n){r.dispatchMessage(n.topic,n,n.controller.toLowerCase())}))},onopen:function(n){if(r.onconnected)r.onconnected(n);r.controllerInstances.forEach(function(n){var t=new XSockets.Message(XSockets.Events.init,{init:!0},n).toString();r.webSocket.send(t)})},onclose:function(n){if(r.ondisconnected)r.ondisconnected(n)},onerror:function(n){if(r.onerror)r.onerror(n)}},t,i)};this.webSocket=r.getInstace(this.uri.absoluteUrl+this.settings.queryString(),this.settings.subprotocol,!1);this.disconnect=function(){this.webSocket.close()};u=function(n){n.forEach(function(n){r.hasOwnProperty(n)&&delete r[n];r.controllerInstances.push(n);r[n]=new XSockets.Controller(n,r.webSocket);r[n].addListener(XSockets.Events.controller.onClose,function(n){var t=new XSockets.ClientInfo(n.CI,n.PI,n.C);if(r.hasOwnProperty(t.controller)&&r[t.controller].onclose)r[t.controller].onclose(t)},n);r[n].addListener(XSockets.Events.controller.onOpen,function(t){var i=new XSockets.ClientInfo(t.CI,t.PI,t.C);if(r[n].clientInfo=i,r.hasOwnProperty(i.controller)&&r[i.controller].onopen)r[i.controller].onopen(i);localStorage.setItem(r.uri.absoluteUrl,i.persistentId)},n);r[n].addListener(XSockets.Events.controller.onError,function(n){if(r.hasOwnProperty(n.controller)&&r[n.controller].onerror)r[n.controller].onerror(n.data);if(r.onerror)r.onerror(n)},n)})};this.reconnect=function(n){r.webSocket=r.getInstace(this.uri.absoluteUrl+this.settings.queryString(),this.settings.subprotocol,!0);u(r.controllerInstances);n&&n()};this.controller=function(n){return r[n.toLowerCase()]};this.dispatchMessage=function(n,t,i){if(i){var u=r[i].subscriptions.get(function(t){return t.topic===n});u&&u.fire(t,function(n){r[i].unsubscribe(n.topic,i)});r[i].promises.hasOwnProperty(n)&&r[i].promises[n].resolve(t);r[i].hasOwnProperty(n)&&r[i][n].call(this,t)}};u(t||[this.uri.controller.toLowerCase()])}return n}();XSockets.Promise=function(){var n=function(n){this.addCallback=n};return n.prototype.then=function(n){var t=new XSockets.Deferred;return this.addCallback(function(){var i=n.apply(null,arguments);i instanceof XSockets.Promise?i.addCallback(t.resolve):t.resolve(i)}),t.promise},n}();XSockets.Deferred=function(){function n(){var t=[],n;this.resolve=function(){if(!n){n=arguments;for(var i;i=t.shift();)i.apply(null,n)}};this.promise=new XSockets.Promise(function(i){n?i.apply(null,n):t.push(i)})}return n}();XSockets.Subscription=function(){function n(n,t,i,r){this.topic=n.toLowerCase();this.fire=function(n,i){t(n);this.count&&(this.count--,this.count===0&&i(this))};this.count=i;this.completed=r}return n}();
/*
//# sourceMappingURL=XSockets.latest.beta.min.js.map
*/